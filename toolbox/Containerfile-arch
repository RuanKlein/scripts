FROM archlinux

LABEL com.github.containers.toolbox="true" \
  com.github.debarshiray.toolbox="true"

ARG JAVA_VERSION=17
ARG LANGUAGE=en_US.UTF-8
ARG YAY_LINK=https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=yay

# To install locale packages
RUN sed -i 's/^\(NoExtract\)/#\1/g' /etc/pacman.conf

# Install packages
RUN pacman --noconfirm -Syu \
  && pacman --noconfirm -S \
  # Reinstall glibc to force install locate package
  glibc \
  base-devel \
  openssh \
  zsh \
  sudo \
  git \
  wget \
  xclip \
  vim \
  php \
  python \
  python-pip \
  jdk${JAVA_VERSION}-openjdk \
  # To get mysql and mysqldump commands
  mariadb-clients \
  # For theme integration with host
  gnome-themes-extra \
  adwaita-icon-theme \
  libadwaita \
  # For xdg-open integration with flatpak apps on host
  flatpak \
  flatpak-xdg-utils \
  # mesa drivers
  mesa \
  mesa-utils \
  # emoji fonts
  noto-fonts-emoji

# Configure location
RUN sed -i "s/^#\(${LANGUAGE}\)/\1/" /etc/locale.gen \
  && echo LANG=${LANGUAGE} > /etc/locale.conf \
  && locale-gen

# Create temporary user to use makepkg
RUN useradd -m -s /bin/bash -d /build build \
  && echo "build ALL=NOPASSWD: ALL" >> /etc/sudoers

WORKDIR /tmp

# Install yay helper
RUN wget -c --timeout=5 ${YAY_LINK} -O PKGBUILD \
  && sudo -u build makepkg --noconfirm -cis \
  && rm -f PKGBUILD

# Install AUR packages
RUN sudo -u build \
  yay --noconfirm -S \
  visual-studio-code-bin

# Remove temporary user
RUN userdel -r build \
  && sed -i '/^build/d' /etc/sudoers \
  && pacman --noconfirm -Scc

# Configure sudo for host user
RUN echo "%wheel ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/toolbox

CMD /usr/bin/zsh
